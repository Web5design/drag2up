<script src="hosts/js/sha1.js"></script>
<script src="hosts/js/md5.js"></script>
<script src="hosts/js/jquery.min.js"></script>


<script src="files.js"></script>
<!--<script src="misc/testing.js"></script>-->


<script src="hosts/imageshack.js"></script>
<script src="hosts/gist.js"></script>
<script src="hosts/pastebin.js"></script>
<script src="hosts/imgur.js"></script>
<script src="hosts/hotfile.js"></script>
<script src="hosts/cloudapp.js"></script>
<script src="hosts/immio.js"></script>
<script src="hosts/flickr.js"></script>

<script src="hosts/picasa/chrome_ex_oauthsimple.js"></script>
<script src="hosts/picasa/chrome_ex_oauth.js"></script>
<script src="hosts/picasa/picasa.js"></script>

<script src="hosts/dropbox/oauth.js"></script>
<script src="hosts/dropbox/modern_dropbox.js"></script>
<script src="hosts/dropbox/dropbox.js"></script>
<script>


var filetable = {};

function params(obj){
  var str = [];
  for(var i in obj) str.push(i+'='+encodeURIComponent(obj[i]));
  return str.join('&');
}


var tabqueue = {};

function https(){
  if(localStorage.no_https == 'on'){
    return 'http://'; //idk why someone would want this
  }
  return 'https://';
}

function handleRequest(request, sender, sendResponse){
  console.log(request)
  console.log('handle request', +new Date);
  var instant = (localStorage.instant || 'on') == 'on'; //woot. its called instant because google made google instant.

  if(instant){
    var car = new racer(2, function(data){
      linkData(request.id, data.url);
    });
  }
  
  if(instant){
    instantInit({name:request.name || 'unknown.filetype', type: request.type || 'application/octet-stream', size: request.size || -1, data: '\xff'}, function(parts){
      car.done();
      console.log('finished initializing instant', +new Date);
      sendResponse({
        callback: request.callback,
        url: https()+'drag2up.appspot.com/'+parts[0]
      })
    })
  }
  console.log('read file', +new Date);
  var tab = sender.tab.id;
  chrome.pageAction.show(tab);
  tabqueue[tab] = (tabqueue[tab] || 0) + 1;
  chrome.pageAction.setTitle({tabId: tab, title: 'Uploading '+tabqueue[tab]+' files...'});
  
  uploadData(request, function(url){
    if(instant){
      car.done({url: url});
    }else if(filetable[request.id]){ //non-instant
      sendResponse({callback: request.callback, url: url})
    }
    tabqueue[tab]--;
    chrome.pageAction.setTitle({tabId: tab, title: 'Uploading '+tabqueue[tab]+' files...'});
    if(tabqueue[tab] == 0) chrome.pageAction.hide(tab);
  });
  
}

//solve race conditions
function racer(num, callback){
  this.num = num;
  this._done = 0;
  this.data = {};
  this.callback = callback;
}
racer.prototype.done = function(data){
  if(data) for(var i in data) this.data[i] = data[i];
  if(++this._done >= this.num) this.callback(this.data);
}


function instantInit(file, callback){
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'https://drag2up.appspot.com/new?'+params({
    host: hostName(file),
    size: file.size,
    name: file.name
  }));
  xhr.onload = function(){
    callback(filetable[file.id] = xhr.responseText.split(','));
  }
  xhr.send();
}


function getURL(type, request, callback){
  if(/^data:/.test(request.url)){
    console.log('opened via data url');
    var parts = request.url.match(/^data:(.+),/)[1].split(';');
    var mime = parts[0], b64 = parts.indexOf('base64') != -1;
    var enc = request.url.substr(request.url.indexOf(',')+1);
    var data = b64 ? atob(enc) : unescape(enc);
    //data urls dont have any weird encoding issue as far as i can tell
    callback({
      data: data,
      type: mime,
      id: request.id,
      size: data.length,
      name: enc.substr(enc.length/2 - 6, 6) + '_' + mime.replace('/','.')
    });
    
    //callback(new dFile(data, name, mime, id, size)
  }else{
    var xhr = new XMLHttpRequest();
    xhr.open('GET', request.url, true);
    if(type == 'binary' || type == 'raw'){
      xhr.overrideMimeType('text/plain; charset=x-user-defined'); //should i loop through and do that & 0xff?
    }
    xhr.onload = function(){
      console.log('opened via xhr ', request.url);
      var raw = xhr.responseText, data = '';
      //for(var l = raw.length, i=0; i<l;i++){ data += String.fromCharCode(raw.charCodeAt(i) & 0xff); if(!(i%(1024 * 1024))) console.log('1mb') };
      //var data = postMessage(raw.split('').map(function(a){return String.fromCharCode(a.charCodeAt(0) & 0xff)}).join(''));
      //window.fd = data;
      
      //var obj = {id: request.id, bin: function(){return raw}, b64: function(){return btoa(data)},type: request.type, size: data.length, name: request.name}
      //callback(obj);
      //because running it here since js is single threaded causes the asynchrouously running instantInit request to be delayed, slowing it down substantially.
      //using a web worker: probably overkill.

      if(type == 'binary'){
        //*
        var bb = new BlobBuilder();//this webworker is totally overkill
        bb.append("onmessage = function(e) { for(var raw = e.data, l = raw.length, i = 0, data = ''; i < l; i++) data += String.fromCharCode(raw.charCodeAt(i) & 0xff); postMessage(data) }");
        var worker = new Worker(createObjectURL(bb.getBlob()));
        worker.onmessage = function(e) {
          var data = e.data;
          callback({id: request.id, data: data, type: request.type, size: data.length, name: request.name});
        };
        worker.postMessage(xhr.responseText);
        //*/
      }else if(type == 'raw'){
        var data = xhr.responseText;
        callback({id: request.id, data: data, type: request.type, size: data.length, name: request.name});
      }else{
        callback({id: request.id, data: raw, type: request.type, size: data.length, name: request.name});
      }
    }
    xhr.send();
  }
}


function getText(request, callback){
  getURL('text', request, callback);
}

function getRaw(request, callback){
  getURL('raw', request, callback);
}

function getBinary(request, callback){
  getURL('binary', request, callback);
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  setTimeout(function(){
    handleRequest(request, sender, sendResponse)
  }, 0);
});



function fileType(file){
  var text_ext = 'log,less,sass,coffee,yaml,json,md,css,cfm,yaws,html,htm,xhtml,js,pl,php,php4,php3,phtml,py,rb,rhtml,xml,rss,svg,cgi'.split(',');
  if(file.type.indexOf('image/') == 0){
	  //image type
	  return 'image'
	}else if(file.type.indexOf('text/') == 0){
	  return 'text'
	}else if(text_ext.indexOf(file.name.replace(/^.*\.(\w+?)$/,'$1')) != -1){
	  return 'text'
	}else if(file.size < 1024 * 1024) { //its rare for text files to be so huge
	  /*
	  var src = file.data;//atob(file.data.replace(/^data.+base64,/i,''));
	  var txt = src.substr(0,512) + src.slice(-512);
	  for(var i = 0, isAscii = true; i < 128; i++){
	    if((txt.charCodeAt(i) & 0xff) > 128){
	     isAscii = false;
	     continue
      }
    }
    if(isAscii && file.size < 1024 * 300) return 'text';
    */
	}
	return 'binary'
}

function hostName(file){
  var typehost = {
    binary: localStorage.binhost || 'hotfile',
	  text: localStorage.texhost || 'gist',
	  image: localStorage.imghost || 'imgur'
	}
	
	var type = fileType(file);
	
	return typehost[type]
}


function uploadData(file, callback){
  //segregate data types, choose blah blah, etc.

	
  var hostfn = {
    hotfile: uploadHotfile,
    gist: uploadGist,
    imgur: uploadImgur,
    imageshack: uploadImageshack,
    dropbox: uploadDropbox,
    pastebin: uploadPastebin,
    cloudapp: uploadCloudApp,
    flickr: uploadFlickr,
    immio: uploadImmio,
    picasa: uploadPicasa
    
  };
  
  var fn = hostfn[hostName(file)];
  if(fn){
    fn(file, callback);
  }else{
    callback('error: no host function for type '+hostName(file)+' for file type '+fileType(file));
  }
  
  //uploadDataURL(file, callback);
}


function uploadDataURL(file, callback){
  //here's the lazy data url encoding system :P
  setTimeout(function(){
    callback(file.data.replace('data:base64','data:text/plain;base64'));
  },1337);
}




function linkData(id, url){
  var xhr = new XMLHttpRequest();
  xhr.open('GET',https()+'drag2up.appspot.com/update/'+filetable[id][0]+'/'+filetable[id][1]+'?'+params({
    url: url
  }), true);
  xhr.onload = function(e){
    if(xhr.status != 200){
      //doomsday scenario: error leads to error leading to error leading to effective DoS
      linkData(id, 'error: could not link to upload url because of '+xhr.status+' '+xhr.statusText)
    }
  }
  xhr.onerror = function(e){
    console.log(e)
    linkData(id, 'error: could not link.')
  }
  xhr.send();
}


chrome.pageAction.onClicked.addListener(function(tab) {
  chrome.tabs.create({url: "options.html", selected: true});
});


</script>
