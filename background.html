<script src="jquery.min.js"></script>
<script src="multipart.js"></script>

<script src="testing.js"></script>
<script src="hosts/imageshack.js"></script>
<script src="hosts/gist.js"></script>
<script src="hosts/pastebin.js"></script>
<script src="hosts/imgur.js"></script>
<script src="hosts/hotfile.js"></script>
<script>
var instant = false; //woot. its called instant because google made google instant.





var filetable = {};

function params(obj){
  var str = [];
  for(var i in obj) str.push(i+'='+encodeURIComponent(obj[i]));
  return str.join('&');
}


var tabqueue = {};

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  console.log(request)
  if(request.action == 'initupload'){
    if(instant){
      var xhr = new XMLHttpRequest();
      xhr.open('GET','http://drag2up.appspot.com/new?'+params({
        host: "TODO: host",
        size: request.size,
        name: request.name
      }), true);
      xhr.onload = function(){
        var parts = xhr.responseText.split(',');
        sendResponse({
          callback: request.callback,
          url: 'http://drag2up.appspot.com/'+parts[0],
          code: parts[1]
        });
        var cb;
        if(filetable[request.id]) cb = filetable[request.id];
        filetable[request.id] = {
          code: parts[1],
          key: parts[0]
        }
        if(cb) cb();
      }
      xhr.send();
    }else{
      filetable[request.id] = {
        fn: sendResponse,
        callback: request.callback
      }
    }
  }else if(request.action == 'uploaddata'){
    var tab = sender.tab.id;
    chrome.pageAction.show(tab);
    tabqueue[tab] = (tabqueue[tab] || 0) + 1;
    
    function doUpload(){
       uploadData({
          data: request.data,
          name: request.name,
          type: request.type,
          size: request.size
        }, function(url){
        var cb = function(){
          if(instant){      
            linkData(request.id, url);
          }else if(filetable[request.id]){ //non-instnat
            filetable[request.id].fn({
              callback: filetable[request.id].callback,
              url: url
            })
          }
          tabqueue[tab]--;
          if(tabqueue[tab] == 0){
            chrome.pageAction.hide(tab);
          }
        };
        
        if(filetable[request.id]) cb(); else filetable[request.id] = cb;
      });
    }
    
    if(request.url){
      if(/^data:/.test(request.url)){
        //reencode all the data urls because they may be escape encoded and to extract the mime type
        var parts = request.url.match(/^data:(.+),/)[0].split(';');
        var data = request.url.substr(request.url.indexOf(',')+1)
        var mime = parts[0], b64 = parts.indexOf('base64') != -1;
        var bin = '';
        if(b64){
          data = atob(data)
        }else{
          data = unescape(data);
        }
        var enc = 'data:'+mime+';base64,'+btoa(data);
        request.type = mime;
        request.data = enc;
        
        doUpload();
        
      }else{
        var xhr = new XMLHttpRequest();
        xhr.open('GET', request.url);
        xhr.onload = function(){
          var mime = xhr.getResponseHeader('Content-Type')||'application/octet-stream';
          request.type = mime;
          request.data = 'data:'+mime+';base64,'+btoa(xhr.responseText);
          doUpload();
        }
      }
    }else{
      doUpload();
    }
    
  }
  
});




function uploadData(file, callback){
  //segregate data types, choose blah blah, etc.
  
  uploadDataURL(file, callback);
}


function uploadDataURL(file, callback){
  //here's the lazy data url encoding system :P
  setTimeout(function(){
    callback(file.data.replace('data:base64','data:text/plain;base64'));
  },1337);
}




function linkData(id, url){
    var xhr = new XMLHttpRequest();
    xhr.open('GET','http://drag2up.appspot.com/update/'+filetable[id].key+'/'+filetable[id].code+'?'+params({
      url: url
    }), true);
    xhr.onload = function(e){
      if(xhr.status != 200){
        //doomsday scenario: error leads to error leading to error leading to effective DoS
        linkData(id, 'error: could not link to upload url because of '+xhr.status+' '+xhr.statusText)
      }
    }
    xhr.onerror = function(e){
      console.log(e)
      linkData(id, 'error: could not link.')
    }
    xhr.send();
}

</script>
