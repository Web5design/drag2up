<script src="jquery.min.js"></script>
<script src="multipart.js"></script>
<!--<script src="misc/testing.js"></script>-->
<script src="hosts/imageshack.js"></script>
<script src="hosts/gist.js"></script>
<script src="hosts/pastebin.js"></script>
<script src="hosts/imgur.js"></script>
<script src="hosts/hotfile.js"></script>
<script src="hosts/cloudapp.js"></script>

<script src="hosts/dropbox/sha1.js"></script>
<script src="hosts/dropbox/oauth.js"></script>
<script src="hosts/dropbox/modern_dropbox.js"></script>
<script src="hosts/dropbox/dropbox.js"></script>
<script>


var filetable = {};

function params(obj){
  var str = [];
  for(var i in obj) str.push(i+'='+encodeURIComponent(obj[i]));
  return str.join('&');
}


var tabqueue = {};


function https(){
  if(localStorage.no_https == 'on'){
    return 'http://'; //idk why someone would want this
  }
  return 'https://';
}

function handleRequest(request, sender, sendResponse){
  console.log(request)
  console.log('handle request', +new Date);
  var instant = (localStorage.instant || 'on') == 'on'; //woot. its called instant because google made google instant.

  if(instant){
    var car = new racer(2, function(data){
      linkData(request.id, data.url);
    });
  }
  
  if(instant){
    instantInit({name:request.name || 'unknown.filetype', type: request.type || 'application/octet-stream', size: request.size || -1, data: '\xff'}, function(parts){
      car.done();
      console.log('finished initializing instant', +new Date);
      sendResponse({
        callback: request.callback,
        url: https()+'drag2up.appspot.com/'+parts[0]
      })
    })
  }
  getURL(request, function(file){
    console.log('read file', +new Date);
    var tab = sender.tab.id;
    chrome.pageAction.show(tab);
    tabqueue[tab] = (tabqueue[tab] || 0) + 1;
    
    uploadData(file, function(url){
      if(instant){
        car.done({url: url});
      }else if(filetable[request.id]){ //non-instant
        sendResponse({callback: request.callback, url: url})
      }
      tabqueue[tab]--;
      if(tabqueue[tab] == 0) chrome.pageAction.hide(tab);
    });
  
    
  });
  
}

//solve race conditions
function racer(num, callback){
  this.num = num;
  this._done = 0;
  this.data = {};
  this.callback = callback;
}
racer.prototype.done = function(data){
  if(data) for(var i in data) this.data[i] = data[i];
  if(++this._done >= this.num) this.callback(this.data);
}


function instantInit(file, callback){
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'https://drag2up.appspot.com/new?'+params({
    host: hostName(file),
    size: file.size,
    name: file.name
  }));
  xhr.onload = function(){
    callback(filetable[file.id] = xhr.responseText.split(','));
  }
  xhr.send();
}

function getURL(request, callback){
  if(/^data:/.test(request.url)){
    console.log('opened via data url');
    var parts = request.url.match(/^data:(.+),/)[1].split(';');
    var mime = parts[0], b64 = parts.indexOf('base64') != -1;
    var enc = request.url.substr(request.url.indexOf(',')+1);
    var data = b64 ? atob(enc) : unescape(enc);
    callback({
      data: data,
      type: mime,
      id: request.id,
      size: data.length,
      name: enc.substr(enc.length/2 - 6, 6) + '_' + mime.replace('/','.')
    });
  }else{
    var xhr = new XMLHttpRequest();
    xhr.open('GET', request.url, true);
    xhr.overrideMimeType('text/plain; charset=x-user-defined'); //should i loop through and do that & 0xff?
    xhr.onload = function(){
      console.log('opened via xhr ', request.url);
      var raw = xhr.responseText, data = '';
      //for(var l = raw.length, i=0; i<l;i++) data += String.fromCharCode(raw.charCodeAt(i) & 0xff);
      //window.fd = data;
      //callback({id: request.id, data: data, type: request.type, size: data.length, name: request.name});
      
      //using a web worker: probably overkill.
      var bb = new BlobBuilder();
      bb.append("onmessage = function(e) { for(var raw = e.data, l = raw.length, i = 0, data = ''; i < l; i++) data += String.fromCharCode(raw.charCodeAt(i) & 0xff); postMessage(data) }");
      var worker = new Worker(createObjectURL(bb.getBlob()));
      worker.onmessage = function(e) {
        var data = e.data;
        callback({id: request.id, data: data, type: request.type, size: data.length, name: request.name});
      };
      worker.postMessage(xhr.responseText);

      
    }
    xhr.send();
  }
}



chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  setTimeout(function(){
    handleRequest(request, sender, sendResponse)
  }, 0);
});



function fileType(file){
  var text_ext = 'log,less,sass,coffee,yaml,json,md,css,cfm,yaws,html,htm,xhtml,js,pl,php,php4,php3,phtml,py,rb,rhtml,xml,rss,svg,cgi'.split(',');
  if(file.type.indexOf('image/') == 0){
	  //image type
	  return 'image'
	}else if(file.type.indexOf('text/') == 0){
	  return 'text'
	}else if(text_ext.indexOf(file.name.replace(/^.*\.(\w+?)$/,'$1')) != -1){
	  return 'text'
	}else if(file.size < 1024 * 1024) { //its rare for text files to be so huge
	  var src = file.data;//atob(file.data.replace(/^data.+base64,/i,''));
	  var txt = src.substr(0,512) + src.slice(-512);
	  for(var i = 0, isAscii = true; i < 128; i++){
	    if(txt.charCodeAt(i) > 128){
	     isAscii = false;
	     continue
      }
    }
    if(isAscii && file.size < 1024 * 300) return 'text';
	}
	return 'binary'
}

function hostName(file){
  var typehost = {
    binary: localStorage.binhost || 'hotfile',
	  text: localStorage.texhost || 'gist',
	  image: localStorage.imghost || 'imgur'
	}
	
	var type = fileType(file);
	
	return typehost[type]
}


function uploadData(file, callback){
  //segregate data types, choose blah blah, etc.

	
  var hostfn = {
    hotfile: uploadHotfile,
    gist: uploadGist,
    imgur: uploadImgur,
    imageshack: uploadImageshack,
    dropbox: uploadDropbox,
    pastebin: uploadPastebin,
    cloudapp: uploadCloudApp
  };
  
  var fn = hostfn[hostName(file)];
  if(fn){
    fn(file, callback);
  }else{
    callback('error: no host function for type '+hostName(file)+' for file type '+fileType(file));
  }
  
  //uploadDataURL(file, callback);
}


function uploadDataURL(file, callback){
  //here's the lazy data url encoding system :P
  setTimeout(function(){
    callback(file.data.replace('data:base64','data:text/plain;base64'));
  },1337);
}




function linkData(id, url){
  var xhr = new XMLHttpRequest();
  xhr.open('GET',https()+'drag2up.appspot.com/update/'+filetable[id][0]+'/'+filetable[id][1]+'?'+params({
    url: url
  }), true);
  xhr.onload = function(e){
    if(xhr.status != 200){
      //doomsday scenario: error leads to error leading to error leading to effective DoS
      linkData(id, 'error: could not link to upload url because of '+xhr.status+' '+xhr.statusText)
    }
  }
  xhr.onerror = function(e){
    console.log(e)
    linkData(id, 'error: could not link.')
  }
  xhr.send();
}

</script>
