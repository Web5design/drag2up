<script src="jquery.min.js"></script>
<script>
var filetable = {};

function params(obj){
  var str = [];
  for(var i in obj) str.push(i+'='+encodeURIComponent(obj[i]));
  return str.join('&');
}
var tabqueue = {};

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  console.log(request)
  if(request.action == 'initupload'){
    var xhr = new XMLHttpRequest();
    xhr.open('GET','http://drag2up.appspot.com/new?'+params({
      host: "TODO: host",
      size: request.size,
      name: request.name
    }), true);
    xhr.onload = function(){
      var parts = xhr.responseText.split(',');
      sendResponse({
        callback: request.callback,
        url: 'http://drag2up.appspot.com/'+parts[0],
        code: parts[1]
      });
      var cb;
      if(filetable[request.id]) cb = filetable[request.id];
      filetable[request.id] = {
        code: parts[1],
        key: parts[0]
      }
      if(cb) cb();
    }
    xhr.send();
  }else if(request.action == 'uploaddata'){
	var tab = sender.tab.id;
	chrome.pageAction.show(tab);
	tabqueue[tab] = (tabqueue[tab] || 0) + 1;

	uploadData({
			data: request.data,
			name: request.name,
			size: request.size
		}, function(url){
		var cb = function(){
			linkData(request.id, url);
			tabqueue[tab]--;
			if(tabqueue[tab] == 0){
				chrome.pageAction.hide(tab);
			}
		};
		
		if(filetable[request.id]) cb(); else filetable[request.id] = cb;
	});
  }
  
});


function uploadData(file, callback){
	//segregate data types, choose blah blah, etc.
	
	uploadDataURL(file, callback);
}


function uploadDataURL(file, callback){
	//here's the lazy data url encoding system :P
	setTimeout(function(){
		callback(data.replace('data:base64','data:text/plain;base64'));
	},1337);
}


function linkData(id, url){
    var xhr = new XMLHttpRequest();
    xhr.open('GET','http://drag2up.appspot.com/update/'+filetable[id].key+'/'+filetable[id].code+'?'+params({
      url: url
    }), true);
    xhr.onload = function(e){
		if(xhr.status != 200){
			//doomsday scenario: error leads to error leading to error leading to effective DoS
			linkData(id, 'error: could not link to upload url because of '+xhr.status+' '+xhr.statusText)
		}
	}
    xhr.send();
}

</script>
