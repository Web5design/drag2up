<script>
var filetable = {};

function params(obj){
  var str = [];
  for(var i in obj) str.push(i+'='+encodeURIComponent(obj[i]));
  return str.join('&');
}


chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  console.log(request)
  if(request.action == 'initupload'){
    var xhr = new XMLHttpRequest();
    xhr.open('GET','http://drag2up.appspot.com/new?'+params({
      host: request.host,
      size: request.size,
      name: request.name
    }), true);
    xhr.onload = function(){
      var parts = xhr.responseText.split(',');
      sendResponse({
        callback: request.callback,
        url: 'http://drag2up.appspot.com/'+parts[0],
        code: parts[1]
      });
      var cb;
      if(filetable[request.id]) cb = filetable[request.id];
      filetable[request.id] = {
        code: parts[1],
        key: parts[0]
      }
      if(cb) cb();
    }
    xhr.send();
  }else if(request.action == 'uploaddata'){
    if(filetable[request.id]){
      linkData(request.id, request.data);
    }else{
      filetable[request.id] = function(){
        linkData(request.id, request.data);
      }
    }
  }
  
});

function linkData(id, url){
    var xhr = new XMLHttpRequest();
    xhr.open('GET','http://drag2up.appspot.com/update/'+filetable[id].key+'/'+filetable[id].code+'?'+params({
      url: url
    }), true);
    xhr.send();
}

</script>
